version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path: []
  requester:
    url_base: "{{ 'https://rest.coinapi.io/v1' if config['environment'] == 'production' else 'https://rest-sandbox.coinapi.io/v1' }}"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      header: "X-CoinAPI-Key"
      api_token: "{{ config['api_key'] }}"
    request_parameters:
      period_id: "{{ config['period'] }}"
      time_start: "{{ config['start_date'] }}"
      time_end: "{{ config['end_date'] }}"
      limit: "{{ config['limit'] }}"

  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"
  base_stream:
    retriever:
      $ref: "#/definitions/retriever"
  ohlcv_historical_data_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "ohlcv_historical_data"
      primary_key: "time_period_start"
      path: "/ohlcv/{{ config['symbol_id'] }}/history"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          time_period_start:
            type:
              - "null"
              - string
            format: date-time
          time_period_end:
            type:
              - "null"
              - string
            format: date-time
          time_open:
            type:
              - "null"
              - string
            format: date-time
          time_close:
            type:
              - "null"
              - string
            format: date-time
          price_open:
            type:
              - "null"
              - number
          price_high:
            type:
              - "null"
              - number
          price_low:
            type:
              - "null"
              - number
          price_close:
            type:
              - "null"
              - number
          volume_traded:
            type:
              - "null"
              - number
          trades_count:
            type:
              - "null"
              - integer
  trades_historical_data_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "trades_historical_data"
      primary_key: "uuid"
      path: "/trades/{{ config['symbol_id'] }}/history"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          symbol_id:
            type:
              - "null"
              - string
          time_period_end:
            type:
              - "null"
              - string
            format: date-time
          time_exchange:
            type:
              - "null"
              - string
            format: date-time
          time_coinapi:
            type:
              - "null"
              - string
            format: date-time
          uuid:
            type:
              - "null"
              - string
          price:
            type:
              - "null"
              - number
          size:
            type:
              - "null"
              - number
          taker_side:
            type:
              - "null"
              - string
  quotes_historical_data_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "quotes_historical_data"
      path: "/quotes/{{ config['symbol_id'] }}/history"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          symbol_id:
            type:
              - "null"
              - string
          time_exchange:
            type:
              - "null"
              - string
            format: date-time
          time_coinapi:
            type:
              - "null"
              - string
            format: date-time
          ask_price:
            type:
              - "null"
              - number
          ask_size:
            type:
              - "null"
              - number
          big_price:
            type:
              - "null"
              - number
          big_size:
            type:
              - "null"
              - number
streams:
  - "#/definitions/ohlcv_historical_data_stream"
  - "#/definitions/trades_historical_data_stream"
  - "#/definitions/quotes_historical_data_stream"

check:
  stream_names:
    - "ohlcv_historical_data"
    - "quotes_historical_data"
spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Coin API Spec
    type: object
    required:
      - api_key
      - environment
      - symbol_id
      - period
      - start_date
    properties:
      api_key:
        type: string
        description: API Key
        airbyte_secret: true
        order: 0
      environment:
        type: string
        description: |
          The environment to use. Either sandbox or production.
        enum:
          - sandbox
          - production
        default: sandbox
        order: 1
      symbol_id:
        type: string
        description: |
          The symbol ID to use. See the documentation for a list.
          https://docs.coinapi.io/#list-all-symbols-get
        order: 2
      period:
        type: string
        description: The period to use. See the documentation for a list. https://docs.coinapi.io/#list-all-periods-get
        examples:
          - 5SEC
          - 2MTH
      start_date:
        type: string
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}$"
        description: The start date in ISO 8601 format.
        examples:
          - "2019-01-01T00:00:00"
      end_date:
        type: string
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}$"
        description: |
          The end date in ISO 8601 format. If not supplied, data will be returned
          from the start date to the current time, or when the count of result
          elements reaches its limit.
        examples:
          - "2019-01-01T00:00:00"
      limit:
        type: integer
        description: |
          The maximum number of elements to return. If not supplied, the default
          is 100. For numbers larger than 100, each 100 items is counted as one
          request for pricing purposes. Maximum value is 100000.
        minimum: 1
        maximum: 100000
        default: 100
  documentation_url: https://docs.airbyte.com/integrations/sources/coin-api
