version: "0.29.0"

definitions:
  requester:
    type: HttpRequester
    url_base: "https://api.aircall.io/v1"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['api_id'] }}"
      password: "{{ config['api_token'] }}"

  record_retriever:
    type: SimpleRetriever
    record_selector:
      type: RecordSelector
      extractor:
        type: DpathExtractor
        field_path: ["{{ parameters.name }}"]
      paginator:
        type: "DefaultPaginator"
        page_size_option:
          type: "RequestOption"
          inject_into: "request_parameter"
          field_name: "{{ response['meta']['per_page'] }}"
        pagination_strategy:
          type: "PageIncrement"
          page_size: 5
        page_token_option:
          type: "RequestOption"
          inject_into: "request_parameter"
          field_name: "{{ response['meta']['page'] }}"

  calls_stream:
    type: DeclarativeStream
    $parameters:
      name: "calls"
      path: "/calls"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Calls Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          country_code_a2:
            type:
              - 'null'
              - string
          pricing_type:
            type:
              - 'null'
              - string
          direct_link:
            type:
              - 'null'
              - string
          direction:
            type:
              - 'null'
              - string
          status:
            type:
              - 'null'
              - string
          missed_call_reason:
            type:
              - 'null'
              - string
          started_at:
            type:
              - 'null'
              - number
          answered_at:
            type:
              - 'null'
              - number
          ended_at:
            type:
              - 'null'
              - number
          duration:
            type:
              - 'null'
              - number
          voicemail:
            type:
              - 'null'
              - string
          recording:
            type:
              - 'null'
              - string
          asset:
            type:
              - 'null'
              - string
          raw_digits:
            type:
              - 'null'
              - string
          user:
            type:
              - 'null'
              - object
            properties:
              id:
                type:
                  - 'null'
                  - number
              direct_link:
                type:
                  - 'null'
                  - string
              name:
                type:
                  - 'null'
                  - string
              email:
                type:
                  - 'null'
                  - string
              available:
                type:
                  - 'null'
                  - boolean
              availability_status:
                type:
                  - 'null'
                  - string
              created_at:
                type:
                  - 'null'
                  - string
              time_zone:
                type:
                  - 'null'
                  - string
              language:
                type:
                  - 'null'
                  - string
          contact:
            type:
              - 'null'
              - string
          archived:
            type:
              - 'null'
              - boolean
          assigned_to:
            type:
              - 'null'
              - string
          transferred_by:
            type:
              - 'null'
              - string
          transferred_to:
            type:
              - 'null'
              - string
          cost:
            type:
              - 'null'
              - string
          number:
            type:
              - 'null'
              - object
            properties:
              id:
                type:
                  - 'null'
                  - number
              direct_link:
                type:
                  - 'null'
                  - string
              name:
                type:
                  - 'null'
                  - string
              digits:
                type:
                  - 'null'
                  - string
              created_at:
                type:
                  - 'null'
                  - string
              country:
                type:
                  - 'null'
                  - string
              time_zone:
                type:
                  - 'null'
                  - string
              open:
                type:
                  - 'null'
                  - boolean
              availability_status:
                type:
                  - 'null'
                  - string
              is_ivr:
                type:
                  - 'null'
                  - boolean
              live_recording_activated:
                type:
                  - 'null'
                  - boolean
              priority:
                type:
                  - 'null'
                  - string
          comments:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - object
              properties:
                id:
                  type:
                    - 'null'
                    - number
                content:
                  type:
                    - 'null'
                    - string
                posted_at:
                  type:
                    - 'null'
                    - number
                posted_by:
                  type:
                    - 'null'
                    - object
                  properties:
                    id:
                      type:
                        - 'null'
                        - number
                    direct_link:
                      type:
                        - 'null'
                        - string
                    name:
                      type:
                        - 'null'
                        - string
                    email:
                      type:
                        - 'null'
                        - string
                    available:
                      type:
                        - 'null'
                        - boolean
                    availability_status:
                      type:
                        - 'null'
                        - string
                    created_at:
                      type:
                        - 'null'
                        - string
          tags:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - object
              properties:
                id:
                  type:
                    - 'null'
                    - number
                name:
                  type:
                    - 'null'
                    - string
                created_at:
                  type:
                    - 'null'
                    - number
                tagged_by:
                  type:
                    - 'null'
                    - object
                  properties:
                    id:
                      type:
                        - 'null'
                        - number
                    direct_link:
                      type:
                        - 'null'
                        - string
                    name:
                      type:
                        - 'null'
                        - string
                    email:
                      type:
                        - 'null'
                        - string
                    available:
                      type:
                        - 'null'
                        - boolean
                    availability_status:
                      type:
                        - 'null'
                        - string
                    created_at:
                      type:
                        - 'null'
                        - string
          teams:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - object
              properties:
                id:
                  type:
                    - 'null'
                    - number
                name:
                  type:
                    - 'null'
                    - string
                direct_link:
                  type:
                    - 'null'
                    - string
                created_at:
                  type:
                    - 'null'
                    - string
  company_stream:
    type: DeclarativeStream
    $parameters:
      name: "company"
      path: "/company"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Company schema
        additionalProperties: true
        type: object
        properties:
          name:
            type:
              - 'null'
              - string
          users_count:
            type:
              - 'null'
              - number
          numbers_count:
            type:
              - 'null'
              - number
  contacts_stream:
    type: DeclarativeStream
    $parameters:
      name: "contacts"
      path: "/contacts"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Contacts Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          first_name:
            type:
              - 'null'
              - string
          last_name:
            type:
              - 'null'
              - string
          company_name:
            type:
              - 'null'
              - string
          information:
            type:
              - 'null'
              - string
          is_shared:
            type:
              - 'null'
              - boolean
          direct_link:
            type:
              - 'null'
              - string
          created_at:
            type:
              - 'null'
              - number
          updated_at:
            type:
              - 'null'
              - number
          phone_numbers:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - object
              properties:
                id:
                  type:
                    - 'null'
                    - number
                label:
                  type:
                    - 'null'
                    - string
                value:
                  type:
                    - 'null'
                    - string
          emails:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - object
              properties:
                id:
                  type:
                    - 'null'
                    - number
                label:
                  type:
                    - 'null'
                    - string
                value:
                  type:
                    - 'null'
                    - string
  numbers_stream:
    type: DeclarativeStream
    $parameters:
      name: "numbers"
      path: "/numbers"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "created_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      cursor_granularity: "PT0.000001S"
      lookback_window: "P31D"
      start_datetime:
        datetime: "{{ config['start_date'] }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: "P1M"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Numbers Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          direct_link:
            type:
              - 'null'
              - string
          name:
            type:
              - 'null'
              - string
          digits:
            type:
              - 'null'
              - string
          country:
            type:
              - 'null'
              - string
          time_zone:
            type:
              - 'null'
              - string
          open:
            type:
              - 'null'
              - boolean
          availability_status:
            type:
              - 'null'
              - string
          is_ivr:
            type:
              - 'null'
              - boolean
          live_recording_activated:
            type:
              - 'null'
              - boolean
          priority:
            type:
              - 'null'
              - string
          messages:
            type:
              - 'null'
              - object
            properties:
              welcome:
                type:
                  - 'null'
                  - string
              waiting:
                type:
                  - 'null'
                  - string
              ivr:
                type:
                  - 'null'
                  - string
              voicemail:
                type:
                  - 'null'
                  - string
              closed:
                type:
                  - 'null'
                  - string
              callback_later:
                type:
                  - 'null'
                  - string
              unanswered_call:
                type:
                  - 'null'
                  - string
              after_hours:
                type:
                  - 'null'
                  - string
              ringing_tone:
                type:
                  - 'null'
                  - string
          wrap_up_time:
            type:
              - 'null'
              - number
          available:
            type:
              - 'null'
              - boolean
          language:
            type:
              - 'null'
              - string
          email:
            type:
              - 'null'
              - string
          created_at:
            type:
              - 'null'
              - string
            format: date-time
  tags_stream:
    type: DeclarativeStream
    $parameters:
      name: "tags"
      path: "/tags"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Tags Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          name:
            type:
              - 'null'
              - string
          color:
            type:
              - 'null'
              - string
          description:
            type:
              - 'null'
              - string
  user_retriever:
    type: SimpleRetriever
    record_selector:
      type: RecordSelector
      extractor:
        type: DpathExtractor
        field_path: ["users"]
    requester:
      $ref: "#/definitions/requester"

  users_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/user_retriever"
    name: "users"
    primary_key: "id"
    $parameters:
      path: "/users"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Users
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          direct_link:
            type:
              - 'null'
              - string
          name:
            type:
              - 'null'
              - string
          email:
            type:
              - 'null'
              - string
          available:
            type:
              - 'null'
              - boolean
          availability_status:
            type:
              - 'null'
              - string
          created_at:
            type:
              - 'null'
              - string
          time_zone:
            type:
              - 'null'
              - string
          language:
            type:
              - 'null'
              - string
          wrap_up_time:
            type:
              - 'null'
              - number
  user_availability_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/user_retriever"
    name: "user_availability"
    primary_key: "id"
    $parameters:
      path: "/users/availabilities"

  teams_stream:
    type: DeclarativeStream
    $parameters:
      name: "teams"
      path: "/teams"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "created_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      cursor_granularity: "PT0.000001S"
      lookback_window: "P31D"
      start_datetime:
        datetime: "{{ config['start_date'] }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: "P1M"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Teams
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          name:
            type:
              - 'null'
              - string
          direct_link:
            type:
              - 'null'
              - string
          created_at:
            type:
              - 'null'
              - string
            format: date-time
          users:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - object
              properties:
                id:
                  type:
                    - 'null'
                    - number
                direct_link:
                  type:
                    - 'null'
                    - string
                name:
                  type:
                    - 'null'
                    - string
                email:
                  type:
                    - 'null'
                    - string
                created_at:
                  type:
                    - 'null'
                    - string
                time_zone:
                  type:
                    - 'null'
                    - string
  webhooks_stream:
    type: DeclarativeStream
    $parameters:
      name: "webhooks"
      path: "/webhooks"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Webhooks Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - 'null'
              - number
          direct_link:
            type:
              - 'null'
              - string
          created_at:
            type:
              - 'null'
              - string
            format: date-time
          url:
            type:
              - 'null'
              - string
          active:
            type:
              - 'null'
              - boolean
          token:
            type:
              - 'null'
              - string
          events:
            type:
              - 'null'
              - array
            items:
              type:
                - 'null'
                - string
streams:
  - "#/definitions/calls_stream"
  - "#/definitions/company_stream"
  - "#/definitions/contacts_stream"
  - "#/definitions/numbers_stream"
  - "#/definitions/tags_stream"
  - "#/definitions/user_availability_stream"
  - "#/definitions/users_stream"
  - "#/definitions/teams_stream"
  - "#/definitions/webhooks_stream"

check:
  type: CheckStream
  stream_names:
    - "calls"
    - "company"
    - "contacts"
    - "numbers"
    - "tags"
    - "user_availability"
    - "users"
    - "teams"
    - "webhooks"
spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Aircall Spec
    type: object
    required:
      - api_id
      - api_token
      - start_date
    additionalProperties: true
    properties:
      api_id:
        title: API ID
        type: string
        description: App ID found at settings https://dashboard.aircall.io/integrations/api-keys
        airbyte_secret: true
      api_token:
        title: API Token
        type: string
        description: App token found at settings (Ref- https://dashboard.aircall.io/integrations/api-keys)
        airbyte_secret: true
      start_date:
        title: Date-From Filter
        type: string
        description: Date time filter for incremental filter, Specify which date to extract from.
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3}Z$"
        examples:
          - "2022-03-01T00:00:00.000Z"
        format: "date-time"
  documentation_url: https://docs.airbyte.com/integrations/sources/aircall
