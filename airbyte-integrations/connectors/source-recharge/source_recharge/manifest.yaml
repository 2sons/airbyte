version: 0.58.4

definitions:
  # API VERSION REFERENCE
  deprecated_api_version:
    x-recharge-version: "2021-01"
  modern_api_version:
    x-recharge-version: "2021-11"
  
  # COMMON PARTS
  schema_loader:
    type: JsonFileSchemaLoader
    file_path: "./source_recharge/schemas/{{ parameters['name'] }}.json"
  selector:
    description: >-
      Base records selector for Full Refresh streams
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["{{ parameters.get('data_path')}}"]
    # apply default schema normalization
    schema_normalization: Default

  authenticator:
    type: ApiKeyAuthenticator
    api_token: "{{ config['access_token'] }}"
    inject_into:
      type: RequestOption
      inject_into: header
      field_name: X-Recharge-Access-Token 

  # PAGINATORS
  paginator_deprecated_api:
    type: DefaultPaginator
    page_token_option:
      type: RequestOption
      inject_into: request_parameter
      field_name: page
    page_size_option:
      inject_into: request_parameter
      field_name: limit
      type: RequestOption
    pagination_strategy:
      type: PageIncrement
      start_from_page: 1
      page_size: 250
      inject_on_first_request: false
  paginator_modern_api:
    type: DefaultPaginator
    page_token_option:
      type: RequestOption
      inject_into: request_parameter
      field_name: cursor
    page_size_option:
      inject_into: request_parameter
      type: RequestOption
      field_name: limit
    pagination_strategy:
      type: CursorPagination
      page_size: 1
      cursor_value: '{{ response.get("next_cursor", {}) }}'
      stop_condition: '{{ not response.get("next_cursor", {}) }}'
  
  # REQUESTERS
  requester_deprecated_api:
    description: >-
      Default Base Requester for Full Refresh streams
    type: HttpRequester
    url_base: https://api.rechargeapps.com/
    path: "{{ parameters['name'] }}"
    http_method: GET
    authenticator:
      $ref: "#/definitions/authenticator"
    request_headers:
      # for deprecated retriever we should use `2021-01` api version
      $ref: "#/definitions/deprecated_api_version"
    error_handler:
      type: "DefaultErrorHandler"

  requester_modern_api:
    description: >-
      Default Base Requester for Full Refresh streams
    # TODO:
    # WHEN the default HttpRequester is used, there is no option to omit passing additional 
    # query params along with `next_page_token`, the fix should be probably be made on the CDK lvl.
    type: HttpRequester
    url_base: https://api.rechargeapps.com/
    path: "{{ parameters['name'] }}"
    http_method: GET
    authenticator:
      $ref: "#/definitions/authenticator"
    request_headers:
      # for modern retriever we should use >= `2021-11` api version
      $ref: "#/definitions/modern_api_version"
    error_handler:
      type: "DefaultErrorHandler"
    request_parameters:
      updated_at_min: '{{ stream_state.get(''updated_at'') if stream_state else config[''start_date''] }}'
  
  # RETRIEVER FOR `DEPRECATED API`
  retriever_api_deprecated:
    description: >-
      Default Retriever for Deprecated API `2021-01` Full Refresh streams.
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester_deprecated_api"
    paginator:
      $ref: "#/definitions/paginator_deprecated_api"

  # RETRIEVER FOR `MODERN API`
  retriever_api_modern:
    description: >-
      Default Retriever for Modern API `2021-11` Full Refresh streams.
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester_modern_api"
    paginator:
      $ref: "#/definitions/paginator_modern_api"
    
  # RETRIEVER FOR `SHOP` STREAM
  retriever_shop_stream:
    $ref: "#/definitions/retriever_api_deprecated"
    # Override the selector to provide the default value
    record_selector:
      $ref: "#/definitions/selector"
      extractor:
        type: DpathExtractor
        field_path: []

  # BASE FULL-REFRESH STREAMS
  base_deprecated_api_stream:
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever_api_deprecated"
  
  base_modern_api_stream:
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever_api_modern"
  
  # BASE INCREMENTAL STREAMS
  base_deprecated_api_incremental_stream:
    $ref: "#/definitions/base_deprecated_api_stream"
  
  base_modern_api_incremental_stream:
    $ref: "#/definitions/base_modern_api_stream"
    incremental_sync:
      # The custom incremental sync was applied because,
      # the cursor for the close_slice() method is determined as NOW(), 
      # instead of the real cursor field (updated_at) value from the record.
      type: CustomIncrementalSync
      class_name: source_recharge.components.datetime_based_cursor.RechargeDateTimeBasedCursor
      cursor_field: "updated_at"
      cursor_datetime_formats:
        - '%Y-%m-%dT%H:%M:%S%z'
      datetime_format: '%Y-%m-%dT%H:%M:%S%z'
      start_datetime:
        type: MinMaxDatetime
        datetime: '{{ config[''start_date''] }}'
        datetime_format: '%Y-%m-%dT%H:%M:%SZ'

  # FULL-REFRESH STREAMS
  # SHOP
  shop_stream:
    $ref: "#/definitions/base_deprecated_api_stream"
    retriever:
      $ref: "#/definitions/retriever_shop_stream"
    primary_key: ["shop", "store"]
    $parameters:
        name: "shop"
  # PRODUCTS
  products_stream:
    $ref: "#/definitions/base_deprecated_api_stream"
    $parameters:
        name: "products"
        data_path: "products"
  
  # INCREMENTAL STREAMS
  # ORDERS
  orders_stream:
    $ref: "#/definitions/base_modern_api_incremental_stream"
    $parameters:
      name: "orders"
      data_path: "orders"

streams:
  - "#/definitions/shop_stream"
  - "#/definitions/products_stream"
  - "#/definitions/orders_stream"

check:
  type: CheckStream
  stream_names:
    - shop
