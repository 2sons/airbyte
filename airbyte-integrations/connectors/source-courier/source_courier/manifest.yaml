version: "0.29.0"

definitions:
  root_selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []

  results_selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path:
        - results

  requester:
    type: HttpRequester
    url_base: "https://api.courier.com"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_key'] }}"

  cursor_paginator:
    type: DefaultPaginator
    page_token_option:
      type: RequestOption
      field_name: cursor
      inject_into: request_parameter
    page_size_option:
      inject_into: request_parameter
      field_name: page_size
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{ response.paging.cursor }}"
      page_size: 1

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/results_selector"

  base_stream:
    type: DeclarativeStream
    primary_key: "id"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      record_selector:
        $ref: "#/definitions/root_selector"

  ## MESSAGES API ##
  messages_stream:
    $ref: "#/definitions/base_stream"
    primary_key: id
    $parameters:
      name: "messages"
      path: "/messages"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/results_selector"
      requester:
        $ref: "#/definitions/requester"
        path: "/messages"
      paginator:
        $ref: "#/definitions/cursor_paginator"

  ## MESSAGE INFO / HISTORY / OUTPUT STREAMS ##
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          id:
            type: string
          idempotencyKey:
            type: string
          listId:
            type: string
          listMessageId:
            type: string
          status:
            type: string
            enum:
              - CLICKED
              - DELIVERED
              - ENQUEUED
              - OPENED
              - SENT
              - UNDELIVERABLE
              - UNMAPPED
              - UNROUTABLE
          enqueued:
            type: number
          sent:
            type: number
          delivered:
            type: number
          opened:
            type: number
          clicked:
            type: number
          recipient:
            type: string
          event:
            type: string
          notification:
            type: string
          error:
            type: string
          reason:
            type: string
            enum:
              - FILTERED
              - NO_CHANNELS
              - NO_PROVIDERS
              - PROVIDER_ERROR
              - UNPUBLISHED
              - UNDELIVERABLE
              - UNSUBSCRIBED
          reasonCode:
            type: string
            enum:
              - HARD
              - SOFT
          reasonDetails:
            type: string
          runId:
            type: string
          providers:
            type: array
            items:
              type: object
              properties:
                channel:
                  type: object
                  properties:
                    key:
                      type: string
                    name:
                      type: string
                    template:
                      type: string
                clicked:
                  type: number
                delivered:
                  type: number
                error:
                  type: string
                provider:
                  type: string
                reference:
                  type: object
                  properties: {}
                  additionalProperties: true
                sent:
                  type: number
                status:
                  type: string
                  enum:
                    - CLICKED
                    - DELIVERED
                    - ENQUEUED
                    - FILTERED
                    - OPENED
                    - SENT
                    - SIMULATED
                    - UNDELIVERABLE
                    - UNMAPPED
                    - UNROUTABLE
  message_id_transformer:
    type: AddFields
    fields:
      - path: ["message_id"]
        value: "{{ stream_slice.id }}"
  message_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/messages_stream"
        parent_key: id
        partition_field: id

  message_info_stream:
    $ref: "#/definitions/base_stream"
    type: DeclarativeStream
    primary_key: id
    $parameters:
      name: message_info
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/messages/{{ stream_slice.id }}"
      partition_router:
        $ref: "#/definitions/message_partition_router"
      record_selector:
        $ref: "#/definitions/root_selector"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          id:
            type: string
          idempotencyKey:
            type: string
          listId:
            type: string
          listMessageId:
            type: string
          status:
            type: string
            enum:
              - CLICKED
              - DELIVERED
              - ENQUEUED
              - OPENED
              - SENT
              - UNDELIVERABLE
              - UNMAPPED
              - UNROUTABLE
          enqueued:
            type: number
          sent:
            type: number
          delivered:
            type: number
          opened:
            type: number
          clicked:
            type: number
          recipient:
            type: string
          event:
            type: string
          notification:
            type: string
          error:
            type: string
          reason:
            type: string
            enum:
              - FILTERED
              - NO_CHANNELS
              - NO_PROVIDERS
              - PROVIDER_ERROR
              - UNPUBLISHED
              - UNDELIVERABLE
              - UNSUBSCRIBED
          reasonCode:
            type: string
            enum:
              - HARD
              - SOFT
          reasonDetails:
            type: string
          runId:
            type: string
          providers:
            type: array
            items:
              type: object
              properties:
                channel:
                  type: object
                  properties:
                    key:
                      type: string
                    name:
                      type: string
                    template:
                      type: string
                clicked:
                  type: number
                delivered:
                  type: number
                error:
                  type: string
                provider:
                  type: string
                reference:
                  type: object
                  properties: {}
                  additionalProperties: true
                sent:
                  type: number
                status:
                  type: string
                  enum:
                    - CLICKED
                    - DELIVERED
                    - ENQUEUED
                    - FILTERED
                    - OPENED
                    - SENT
                    - SIMULATED
                    - UNDELIVERABLE
                    - UNMAPPED
                    - UNROUTABLE
  message_history_stream:
    type: DeclarativeStream
    $parameters:
      name: message_history
    primary_key: message_id
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          message_id:
            type: string
          ts:
            type: number
          type:
            type: string
          data:
            type: object
            properties: {}
            additionalProperties: true
          event:
            type: string
          profile:
            type: object
            properties: {}
            additionalProperties: true
          override:
            type: object
            properties: {}
            additionalProperties: true
          recipient:
            type: string
          event_id:
            type: string
          notification_id:
            type: string
          merged_profile:
            type: object
            properties: {}
            additionalProperties: true
          received_profile:
            type: object
            properties: {}
            additionalProperties: true
          stored_profile:
            type: object
            properties: {}
            additionalProperties: true
          output:
            type: object
            properties: {}
            additionalProperties: true
          channel:
            type: object
            properties:
              id:
                type: string
              label:
                type: string
          integration:
            type: object
            properties:
              id:
                type: string
              provider:
                type: string
          reason:
            type: string
            enum:
              - FILTERED
              - NO_CHANNELS
              - NO_PROVIDERS
              - PROVIDER_ERROR
              - UNPUBLISHED
              - UNDELIVERABLE
              - UNSUBSCRIBED
          reasonCode:
            type: string
            enum:
              - HARD
              - SOFT
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/results_selector"
      requester:
        $ref: "#/definitions/requester"
        path: "/messages/{{ stream_slice.id }}/history"
      partition_router:
        $ref: "#/definitions/message_partition_router"
    transformations:
      - $ref: "#/definitions/message_id_transformer"

  message_output_stream:
    type: DeclarativeStream
    $parameters:
      name: message_output
    primary_key: message_id
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        properties:
          message_id:
            type: string
          channel:
            type: string
          channel_id:
            type: string
          content:
            properties:
              blocks:
                type: array
              body:
                type: string
              html:
                type: string
              subject:
                type: string
              text:
                type: string
              title:
                type: string
            type: object
        type: object
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/results_selector"
      requester:
        $ref: "#/definitions/requester"
        path: "/messages/{{ stream_slice.id }}/output"
      partition_router:
        $ref: "#/definitions/message_partition_router"
    transformations:
      - $ref: "#/definitions/message_id_transformer"

streams:
  - "#/definitions/messages_stream"
  - "#/definitions/message_info_stream"
  - "#/definitions/message_history_stream"
  - "#/definitions/message_output_stream"

check:
  type: CheckStream
  stream_names: ["messages"]
spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Courier Source Spec
    type: object
    required:
      - api_key
    additionalProperties: true
    properties:
      api_key:
        type: string
        description: Courier API Key to retrieve your data.
        airbyte_secret: true
  documentation_url: https://docs.airbyte.io/integrations/sources/courier
